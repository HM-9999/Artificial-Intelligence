# 自動学習機能について

## 概要
このシステムは、質問されたデータを自動的に学習する機能を実装しています。ユーザーが質問ボタンを押す必要はなく、システムが内部で自動的に学習を行います。

## 自動学習の仕組み

### 1. 学習トリガー
以下の条件で自動学習が実行されます：
- 質問に対する回答が見つからない場合
- 類似質問の類似度が0.5未満の場合

### 2. 学習プロセス
1. ユーザーが質問を送信
2. システムが既存データから回答を検索
3. 回答が見つからない、または類似度が低い場合
4. 自動的に学習データとして保存
5. ユーザーに学習完了を通知

### 3. 学習データの構造
```json
{
  "id": 自動生成ID,
  "question": "ユーザーの質問",
  "answer": "この質問に対する回答を準備中です。",
  "category": "自動学習データ",
  "tags": ["自動学習", "未回答"],
  "difficulty": "初級",
  "learned_date": "学習日時",
  "user_feedback": "システムが自動的に学習しました"
}
```

## 技術的実装

### バックエンド（app.py）
- `search_ajax()` 関数で自動学習ロジックを実装
- 類似度計算による学習判定
- `KeioQAAnalyzer.learn_new_qa()` で学習データを保存

### フロントエンド（index.html）
- 学習ボタンを削除
- 自動学習通知機能を追加
- ユーザーに学習完了を視覚的に通知

## 学習データの保存場所
- ファイル: `learned_qa_data.json`
- 形式: JSON
- 構造: 学習したQ&Aペアのリスト

## メリット
1. **ユーザーフレンドリー**: 手動操作不要
2. **継続的改善**: システムが自動的に知識を拡張
3. **効率的**: 類似度ベースの学習判定
4. **透明性**: 学習完了をユーザーに通知

## 注意事項
- 学習データは永続的に保存されます
- 類似度0.5以上の質問は重複学習を避けるため学習されません
- 学習データは元のデータセットとは別に管理されます 

# 予想回答生成・保存機能

## 概要

この機能は、現在の質問を基に予想質問を生成し、その回答も自動的に生成して `keio_qa_dataset.json` に保存するプログラムです。

## 特徴

- ✅ **予想質問を表示しない**: ユーザーには予想質問を表示せず、バックグラウンドで処理
- ✅ **回答も自動生成**: 予想された質問に対する回答を自動的に生成
- ✅ **データセットに保存**: 生成されたQ&Aを `keio_qa_dataset.json` に保存
- ✅ **フォーマット準拠**: 既存のデータセットフォーマットに完全準拠
- ✅ **重複チェック**: 既存の質問と重複しないようチェック
- ✅ **メタデータ更新**: 保存時にメタデータ（総数、更新日）を自動更新

## 実装された機能

### 1. `predict_and_save_answers` メソッド

```python
def predict_and_save_answers(self, current_question: str, current_answer: str = None, limit: int = 5) -> Dict:
    """予想質問を生成し、その回答も予想してkeio_qa_dataset.jsonに保存"""
```

**パラメータ:**
- `current_question`: 現在の質問（必須）
- `current_answer`: 現在の回答（オプション）
- `limit`: 生成するQ&Aの最大数（デフォルト: 5）

**戻り値:**
```python
{
    "success": True,
    "current_question": "質問内容",
    "detected_keywords": ["キーワード1", "キーワード2"],
    "detected_categories": ["カテゴリ1", "カテゴリ2"],
    "detected_departments": ["学部1", "学部2"],
    "total_predicted": 15,
    "saved_count": 3,
    "message": "3個の予想Q&Aをデータセットに保存しました"
}
```




]### 2. 回答生成機能

#### `_generate_answer_for_question` メソッド

カテゴリ別の回答テンプレートを使用して、質問に対する回答を自動生成します。

**対応カテゴリ:**
- 入試
- キャンパス
- 授業
- 就職
- 留学
- 学生生活
- 奨学金
- キーワード関連
- 類似質問関連

### 3. データセット保存機能

#### `_save_predicted_qa_to_dataset` メソッド

生成されたQ&Aをデータセットに保存します。

**保存される情報:**
- ID（自動採番）
- 質問
- 回答
- カテゴリ
- タグ（自動生成）
- 難易度（デフォルト: "初級"）

### 4. タグ生成機能

#### `_generate_tags_for_qa` メソッド

質問とカテゴリから適切なタグを自動生成します。

## 使用方法

### 1. コマンドラインでの使用

```python
from keio_qa_analyzer import KeioQAAnalyzer

# アナライザーを初期化
analyzer = KeioQAAnalyzer()

# 予想回答生成・保存を実行
result = analyzer.predict_and_save_answers(
    current_question="慶應義塾大学の入試について教えてください",
    limit=3
)

if result.get('success'):
    print(f"保存されたQ&A数: {result.get('saved_count')}")
    print(f"メッセージ: {result.get('message')}")
else:
    print(f"エラー: {result.get('error')}")
```

### 2. Web APIでの使用

```bash
curl -X POST http://localhost:5000/predict_and_save_answers \
  -H "Content-Type: application/json" \
  -d '{
    "current_question": "慶應義塾大学の入試について教えてください",
    "limit": 3
  }'
```

### 3. デモスクリプトの実行

```bash
cd Python
python predict_and_save_demo.py
```

### 4. テストスクリプトの実行

```bash
cd Python
python test_predict_and_save.py
```

## データセットフォーマット

保存されるQ&Aは以下のフォーマットに準拠します：

```json
{
  "id": 21,
  "question": "文学部の入試対策はどうすればいいですか",
  "answer": "文学部の入試について説明いたします。\n\n• 入試科目：国語、数学、英語、社会、理科\n• 合格率：約15%\n• 入試日程：1月下旬〜2月上旬\n\n詳細については、慶應義塾大学の公式ホームページで最新情報をご確認ください。",
  "category": "入試",
  "tags": ["入試", "文学部", "受験", "合格", "対策"],
  "difficulty": "初級"
}
```

## アルゴリズム

### 1. キーワード抽出
現在の質問からキーワードを抽出し、関連するカテゴリや学部を特定します。

### 2. 予想質問生成
以下の3つの方法で予想質問を生成します：

1. **カテゴリベース**: 検出されたカテゴリに基づく質問パターン
2. **キーワードベース**: 抽出されたキーワードに関連する質問
3. **類似質問ベース**: 類似質問から関連する質問を生成

### 3. 回答生成
カテゴリ別のテンプレートを使用して、予想質問に対する回答を自動生成します。

### 4. データ保存
生成されたQ&Aをデータセットに保存し、メタデータを更新します。

## エラーハンドリング

- ファイル読み込みエラー
- データセット保存エラー
- モデル初期化エラー
- メモリ不足エラー

## パフォーマンス

- 1回の実行で最大5個のQ&Aを生成・保存
- 重複チェックにより既存データとの重複を防止
- メモリ効率的な処理

## 制限事項

- 生成される回答はテンプレートベースのため、完全にオリジナルではありません
- 質問の複雑さによっては適切な回答が生成されない場合があります
- データセットのサイズが大きくなると処理時間が増加します

## 今後の改善点

- より高度な自然言語生成モデルの導入
- 回答の品質向上
- より多様な質問パターンの追加
- ユーザーフィードバック機能の追加 
